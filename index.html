<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Clock In / Out</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont;
  background: linear-gradient(180deg,#0f2027,#203a43,#2c5364);
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card {
  width:100%;
  max-width:360px;
  background:rgba(0,0,0,.35);
  padding:24px;
  border-radius:16px;
  position: relative;
}

.card {
  position: relative;
}

#menuBtn {
  position: absolute;
  top: 16px;
  right: 16px;
  background: none;
  border: none;
  font-size: 22px;
  color: white;
}

button {
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  font-weight:600;
}
.primary { background:#00e676; color:#000; }
.secondary { background:#ff5252; color:#fff; }
#controls { display:none; }
#status { margin-top:12px; text-align:center; }

input {
  width: 100%;
  display: block;
  padding: 14px;
  margin-bottom: 12px;
  border-radius: 12px;
  border: none;
  font-size: 16px;
}

#login button {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
}
</style>
</head>

<body>
<div class="card">
  <h1>Clock In / Out</h1>

  <!-- LOGIN ONLY -->
  <div id="login">
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
  </div>

  <!-- LOGGED-IN ONLY -->
  <div id="app" style="display:none;">

    <button id="menuBtn" onclick="toggleMenu()">☰</button>

    <div id="menu" style="display:none;">
      <p><strong>Account:</strong> <span id="userEmail"></span></p>
      <p><strong>Hourly Rate:</strong> $<span id="rate"></span>/hr</p>
      <p><strong>Total Hours:</strong> <span id="totalHours"></span></p>
      <p><strong>Total Earned:</strong> $<span id="totalPay"></span></p>
      <button onclick="openRequest()">Request Time Change</button>
    </div>

    <div id="controls">
      <button class="primary" onclick="clockIn()">Clock In</button>
      <button class="secondary" onclick="clockOut()">Clock Out</button>
      <div id="status"></div>
    </div>

    <div id="history">
      <h3>Work History</h3>
      <div id="historyList"></div>
    </div>

    <div id="requestBox" style="display:none;">
      <h3>Request Time Change</h3>
      <input type="date" id="reqDate">
      <input type="time" id="reqIn">
      <input type="time" id="reqOut">
      <input type="text" id="reqReason" placeholder="Reason">
      <button onclick="submitRequest()">Submit Request</button>
    </div>

    <button id="logoutBtn" onclick="logout()">Log out</button>

  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCnzBdlGPviltn6P8pID14lgkXHx6zQifA",
  authDomain: "clock-in-out-56209.firebaseapp.com",
  projectId: "clock-in-out-56209",
  storageBucket: "clock-in-out-56209.appspot.com",
  messagingSenderId: "285481914024",
  appId: "1:285481914024:web:4efcca9a9c476fec9f3c9d"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBox = document.getElementById("login");
const controlsBox = document.getElementById("controls");
const statusText = document.getElementById("status");
const logoutBtn = document.getElementById("logoutBtn");

function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  if (!email || !password) {
    alert("Enter email and password");
    return;
  }

  auth.signInWithEmailAndPassword(email, password)
    .catch(e => alert(e.message));
}

const appBox = document.getElementById("app");

auth.onAuthStateChanged(async user => {
  if (!user) {
    loginBox.style.display = "block";
    appBox.style.display = "none";
    return;
  }

  loginBox.style.display = "none";
  appBox.style.display = "block";

  document.getElementById("userEmail").innerText = user.email;

  loadEmployeeData(user);

  const doc = await db.collection("users").doc(user.uid).get();
  if (doc.exists && doc.data().status === "in") {
    showIn(doc.data().since.toDate().toLocaleTimeString());
  } else {
    showOut();
  }
});


  const doc = await db.collection("users").doc(user.uid).get();
  if (doc.exists && doc.data().status === "in") {
    showIn(doc.data().since.toDate().toLocaleTimeString());
  } else {
    showOut();
  }
});

function showIn(t){ 
  document.querySelector(".primary").style.display="none";
  document.querySelector(".secondary").style.display="block";
  statusText.innerText = `CLOCKED IN since ${t}`;
}
function showOut(){
  document.querySelector(".primary").style.display="block";
  document.querySelector(".secondary").style.display="none";
  statusText.innerText = "CLOCKED OUT";
}

async function clockIn(){
  const now=new Date();
  await db.collection("logs").add({
    uid:auth.currentUser.uid,
    type:"in",
    time:now
  });
  await db.collection("users").doc(auth.currentUser.uid).set({
    email:auth.currentUser.email,
    status:"in",
    since:now
  },{merge:true});
  showIn(now.toLocaleTimeString());
}

async function clockOut(){
  const now=new Date();
  await db.collection("logs").add({
    uid:auth.currentUser.uid,
    type:"out",
    time:now
  });
  await db.collection("users").doc(auth.currentUser.uid).set({
    email:auth.currentUser.email,
    status:"out"
  },{merge:true});
  showOut();
}

function logout(){
  auth.signOut().then(()=>location.reload());
}

let hourlyRate = 20; // change later or store per-user

function toggleMenu() {
  const m = document.getElementById("menu");
  m.style.display = m.style.display === "none" ? "block" : "none";
}

function openRequest() {
  document.getElementById("requestBox").style.display = "block";
}

async function loadEmployeeData(user) {
  document.getElementById("userEmail").innerText = user.email;
  document.getElementById("rate").innerText = hourlyRate.toFixed(2);

  const snap = await db.collection("logs")
    .where("uid", "==", user.uid)
    .orderBy("time")
    .get();

  const days = {};
  let totalMs = 0;
  let lastIn = null;

  snap.forEach(doc => {
    const d = doc.data();
    const date = d.time.toDate().toDateString();

    if (!days[date]) days[date] = [];
    days[date].push(d);

    if (d.type === "in") lastIn = d.time.toDate();
    if (d.type === "out" && lastIn) {
      totalMs += d.time.toDate() - lastIn;
      lastIn = null;
    }
  });

  const hours = totalMs / 3600000;
  document.getElementById("totalHours").innerText = hours.toFixed(2);
  document.getElementById("totalPay").innerText = (hours * hourlyRate).toFixed(2);

  renderHistory(days);
}

function renderHistory(days) {
  const box = document.getElementById("historyList");
  box.innerHTML = "";

  for (const day in days) {
    const dayDiv = document.createElement("div");
    dayDiv.innerHTML = `<strong>${day}</strong>`;

    let lastIn = null;

    days[day].forEach(log => {
      if (log.type === "in") {
        lastIn = log.time.toDate();
      } else if (log.type === "out" && lastIn) {
        const out = log.time.toDate();
        const hrs = ((out - lastIn) / 3600000).toFixed(2);
        dayDiv.innerHTML += `
          <div style="margin-left:12px;">
            ${lastIn.toLocaleTimeString()} → ${out.toLocaleTimeString()}
            (${hrs} hrs)
          </div>`;
        lastIn = null;
      }
    });

    box.appendChild(dayDiv);
  }
}

async function submitRequest() {
  const user = auth.currentUser;
  if (!user) return;

  await db.collection("requests").add({
    uid: user.uid,
    email: user.email,
    date: reqDate.value,
    clockIn: reqIn.value,
    clockOut: reqOut.value,
    reason: reqReason.value,
    createdAt: new Date()
  });

  alert("Request submitted");
  document.getElementById("requestBox").style.display = "none";
}
</script>
</body>
</html>